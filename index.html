<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IT Team Lucky Draw Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* ================= ìŠ¤íƒ€ì¼ ì •ì˜ ================= */
        * { box-sizing: border-box; }
        body {
            background-color: #000;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 1. ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #control-panel {
            flex: 0 0 auto;
            background: #111;
            border-bottom: 1px solid #333;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }

        select {
            background: #000;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 5px;
            font-family: inherit;
            max-width: 60%;
        }

        button.btn-util {
            background: #003300;
            color: #fff;
            border: 1px solid #00ff41;
            padding: 5px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        /* 2. ë©”ì¸ ìŠ¤ìº” ì˜ì—­ */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
        }

        #reader {
            width: 100%;
            height: 100%;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        #reader video {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        .mirrored video { transform: scaleX(-1) !important; }

        .scan-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 250px; height: 250px;
            border: 2px solid rgba(0, 255, 65, 0.5);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
            pointer-events: none;
            z-index: 10;
        }
        .scan-guide::before, .scan-guide::after {
            content: ''; position: absolute; background: #00ff41;
        }
        .scan-guide::before { top: 50%; left: 10%; width: 80%; height: 2px; }
        .scan-guide::after { left: 50%; top: 10%; height: 80%; width: 2px; }


        /* 3. ê²°ê³¼ í™”ë©´ (ìˆ˜ì •ë¨: ì—¬ë°± ìµœì†Œí™” ë° í¬ê¸° í™•ëŒ€) */
        #result-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            padding: 2vmin; /* ì „ì²´ íŒ¨ë”© ìµœì†Œí™” */
        }

        .log-text { font-size: 4vmin; color: #ccffcc; margin-bottom: 20px; white-space: pre-wrap; text-align: left; width: 80%; }
        
        /* [ìˆ˜ì •] íƒ€ì´í‹€ í¬ê¸° í‚¤ìš°ê³  ì—¬ë°± ì¤„ì„ */
        .winner-title { 
            font-size: 8vmin; 
            color: #fff; 
            margin-bottom: 2vmin; 
        }
        
        /* [ìˆ˜ì •] ì´ë¦„ í¬ê¸° ì´ˆëŒ€í˜•í™”, ì¤„ê°„ê²© ì¡°ì • */
        .winner-name { 
            font-size: 30vmin; /* í›¨ì”¬ ì»¤ì§ */
            line-height: 1.1;
            font-weight: bold; 
            color: #00ff41; 
            text-shadow: 0 0 40px #00ff41; 
            animation: pulse 0.5s infinite alternate;
            word-break: keep-all; /* ì´ë¦„ì´ ê¸¸ì–´ë„ ë‹¨ì–´ ìœ ì§€ */
        }
        
        /* [ìˆ˜ì •] ì•ˆë‚´ë¬¸êµ¬ í¬ê¸° í‚¤ìš°ê³  ì—¬ë°± ì¤„ì„ */
        .reset-msg { 
            margin-top: 5vmin; 
            color: #888; 
            font-size: 4vmin; 
        }

        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.02); } }
        
        #progress-bar-container { width: 80%; height: 10px; background: #222; margin-top: 20px; display: none; }
        #progress-bar { width: 0%; height: 100%; background: #00ff41; transition: width 0.1s; }

    </style>
</head>
<body>

    <div id="control-panel">
        <select id="camera-select" onchange="startScanner(this.value)">
            <option value="" disabled selected>Loading Cameras...</option>
        </select>
        <button class="btn-util" onclick="toggleMirror()">â‡„ ë°˜ì „</button>
    </div>

    <main>
        <div id="reader">
            <div class="scan-guide"></div> 
        </div>

        <div id="result-overlay">
            <div id="log-area" class="log-text"></div>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
            
            <div id="final-result" style="display:none; text-align:center; width: 100%;">
                <div class="winner-title">ğŸ‰ WINNER ğŸ‰</div>
                <div id="winner-name" class="winner-name"></div>
                <div class="reset-msg">í„°ì¹˜í•˜ì—¬ ë‹¤ìŒ ì¶”ì²¨ ì§„í–‰</div>
            </div>
        </div>
    </main>

    <script>
        // ================= ë°ì´í„° ì„¤ì • =================
        const participants = {
            1: "ì´í˜œì •", 2: "í™©ë¯¼ì£¼", 3: "ì•ˆì¸ê²½", 4: "ìµœìœ¤ì˜", 5: "ê¹€ê·¼ë§Œ",
            6: "ì´ì„ êµ­", 7: "ìœ¤ì¼ì„", 8: "ì†¡ì£¼í˜„", 9: "ê¹€íƒœì˜¤", 10: "ì´ê·¼í˜¸",
            11: "ì„ì£¼í˜„", 12: "ìµœì •í™˜", 13: "ì„ë•ì›", 14: "ë°•ìœ¤í•œ", 15: "ì‹¬ì¤€ì˜",
            16: "ì´í˜„ì² ", 17: "ê°•ëŒ€í¬", 18: "í˜„ì§„ë‚¨", 19: "ì´ì§„ìš°"
        };

        // ì „ì—­ ë³€ìˆ˜
        let html5QrCode;
        let isScanning = false;
        let currentCameraId = null;

        // [ê¸°ì–µ ê¸°ëŠ¥] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤ ì´ë¦„
        const STORAGE_KEY_CAMERA = 'luckyDraw_cameraId';
        const STORAGE_KEY_MIRROR = 'luckyDraw_isMirrored';

        // 1. ì´ˆê¸°í™” ë° ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            html5QrCode = new Html5Qrcode("reader");
            
            const savedMirror = localStorage.getItem(STORAGE_KEY_MIRROR);
            if (savedMirror === 'true') {
                document.getElementById('reader').classList.add('mirrored');
            }

            Html5Qrcode.getCameras().then(devices => {
                const select = document.getElementById('camera-select');
                select.innerHTML = ""; 

                if (devices && devices.length) {
                    const savedCameraId = localStorage.getItem(STORAGE_KEY_CAMERA);
                    let targetCameraId = null;

                    devices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.text = device.label || `Camera ${index} (${device.id.substr(0,5)}...)`;
                        select.appendChild(option);

                        if (savedCameraId && device.id === savedCameraId) {
                            targetCameraId = savedCameraId;
                        }
                    });

                    if (!targetCameraId) {
                        targetCameraId = devices[devices.length - 1].id;
                    }

                    select.value = targetCameraId;
                    startScanner(targetCameraId);

                } else {
                    select.innerHTML = "<option>No Camera Found</option>";
                    alert("ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }).catch(err => {
                console.error(err);
                alert("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
            });
        });

        // 2. ìŠ¤ìºë„ˆ ì‹œì‘ í•¨ìˆ˜
        function startScanner(cameraId) {
            localStorage.setItem(STORAGE_KEY_CAMERA, cameraId);

            if(isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    startScanner(cameraId); 
                });
                return;
            }

            currentCameraId = cameraId;
            
            const config = {
                fps: 10,
                qrbox: { width: 300, height: 300 },
                videoConstraints: {
                    deviceId: { exact: cameraId },
                    width: { min: 1280, ideal: 1920 },
                    height: { min: 720, ideal: 1080 },
                    focusMode: "continuous"
                }
            };

            html5QrCode.start(
                cameraId, 
                config, 
                onScanSuccess, 
                (errorMessage) => { /* ë¬´ì‹œ */ }
            ).then(() => {
                isScanning = true;
                updateMirrorStyle();
            }).catch(err => {
                console.error("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨", err);
            });
        }

        // 3. ì¢Œìš° ë°˜ì „ í† ê¸€ ë° ì €ì¥
        function toggleMirror() {
            const reader = document.getElementById('reader');
            const isMirrored = reader.classList.toggle('mirrored');
            localStorage.setItem(STORAGE_KEY_MIRROR, isMirrored);
        }
        
        function updateMirrorStyle() {
            const reader = document.getElementById('reader');
            if(reader.classList.contains('mirrored')) {
                const video = document.querySelector('#reader video');
                if(video) video.style.transform = "scaleX(-1)";
            }
        }

        // 4. ìŠ¤ìº” ì„±ê³µ
        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return;

            const id = parseInt(decodedText);
            if (participants[id]) {
                isScanning = false;
                html5QrCode.stop().then(() => {
                    showResultEffect(id, participants[id]);
                });
            }
        }

        // 5. ê²°ê³¼ ì—°ì¶œ
        function showResultEffect(id, name) {
            const overlay = document.getElementById('result-overlay');
            const logArea = document.getElementById('log-area');
            const progBarContainer = document.getElementById('progress-bar-container');
            const progBar = document.getElementById('progress-bar');
            const finalResult = document.getElementById('final-result');
            const winnerName = document.getElementById('winner-name');

            overlay.style.display = 'flex';
            logArea.innerHTML = '';
            logArea.style.display = 'block'; 
            progBarContainer.style.display = 'block';
            finalResult.style.display = 'none';
            progBar.style.width = '0%'; 

            const logs = [
                `>> TARGET ID DETECTED: [ ${id} ]`,
                `>> ê³µì •í•œ ì„œë²„ë¡œ ì ‘ì†ì¤‘...`,
                `>> VERIFYING HASH KEY... OK`,
                `>> DECRYPTING DATA STREAM...`,
                `>> MATCH FOUND IN DATABASE.`
            ];

            let step = 0;
            const totalSteps = logs.length;
            
            const interval = setInterval(() => {
                if(step < totalSteps) {
                    logArea.innerHTML += logs[step] + "<br>";
                    progBar.style.width = ((step + 1) / totalSteps * 100) + "%";
                    step++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        logArea.style.display = 'none';
                        progBarContainer.style.display = 'none';
                        
                        winnerName.innerText = name;
                        finalResult.style.display = 'block';
                        
                        overlay.onclick = resetGame;
                    }, 500);
                }
            }, 400);
        }

        // 6. ê²Œì„ ì¬ì‹œì‘ (Soft Reset)
        function resetGame() {
            const overlay = document.getElementById('result-overlay');
            overlay.style.display = 'none';
            overlay.onclick = null; 

            if (currentCameraId) {
                startScanner(currentCameraId);
            }
        }
    </script>
</body>
</html>
