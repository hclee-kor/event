<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IT Team Lucky Draw Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* ================= ìŠ¤íƒ€ì¼ ì •ì˜ ================= */
        * { box-sizing: border-box; }
        body {
            background-color: #000;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 1. ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ì¹´ë©”ë¼ ì„ íƒ ë“±) */
        #control-panel {
            flex: 0 0 auto;
            background: #111;
            border-bottom: 1px solid #333;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }

        select {
            background: #000;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 5px;
            font-family: inherit;
            max-width: 50%;
        }

        button.btn-util {
            background: #003300;
            color: #fff;
            border: 1px solid #00ff41;
            padding: 5px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        /* 2. ë©”ì¸ ìŠ¤ìº” ì˜ì—­ */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
        }

        #reader {
            width: 100%;
            height: 100%;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        /* ë¹„ë””ì˜¤ ìš”ì†Œ ìŠ¤íƒ€ì¼ (ê½‰ ì°¨ê²Œ) */
        #reader video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* í™”ë©´ ê½‰ ì±„ìš°ê¸° */
        }

        /* ì¢Œìš° ë°˜ì „ í´ë˜ìŠ¤ (CSS Transform) */
        .mirrored video {
            transform: scaleX(-1) !important;
        }

        /* ìŠ¤ìº” ê°€ì´ë“œ ë¼ì¸ (ì‹­ìì„ ) */
        .scan-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 250px; height: 250px;
            border: 2px solid rgba(0, 255, 65, 0.5);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
            pointer-events: none;
            z-index: 10;
        }
        .scan-guide::before, .scan-guide::after {
            content: ''; position: absolute; background: #00ff41;
        }
        .scan-guide::before { top: 50%; left: 10%; width: 80%; height: 2px; } /* ê°€ë¡œì„  */
        .scan-guide::after { left: 50%; top: 10%; height: 80%; width: 2px; } /* ì„¸ë¡œì„  */


        /* 3. ê²°ê³¼ í™”ë©´ (í‰ì†Œì—” ìˆ¨ê¹€) */
        #result-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: none; /* JSë¡œ ì œì–´ */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .log-text { font-size: 4vmin; color: #ccffcc; margin-bottom: 20px; white-space: pre-wrap; text-align: left; width: 80%; }
        .winner-title { font-size: 5vmin; color: #fff; margin-bottom: 20px; }
        .winner-name { font-size: 15vmin; font-weight: bold; color: #00ff41; text-shadow: 0 0 30px #00ff41; animation: pulse 0.5s infinite alternate; }
        .reset-msg { margin-top: 50px; color: #666; font-size: 2vmin; }

        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
        
        /* ì§„í–‰ë¥  ë°” */
        #progress-bar-container { width: 80%; height: 10px; background: #222; margin-top: 20px; display: none; }
        #progress-bar { width: 0%; height: 100%; background: #00ff41; transition: width 0.1s; }

    </style>
</head>
<body>

    <div id="control-panel">
        <select id="camera-select" onchange="startScanner(this.value)">
            <option value="" disabled selected>Loading Cameras...</option>
        </select>
        <button class="btn-util" onclick="toggleMirror()">â‡„ ë°˜ì „</button>
    </div>

    <main>
        <div id="reader">
            <div class="scan-guide"></div> </div>

        <div id="result-overlay">
            <div id="log-area" class="log-text"></div>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
            
            <div id="final-result" style="display:none; text-align:center;">
                <div class="winner-title">ğŸ‰ WINNER ğŸ‰</div>
                <div id="winner-name" class="winner-name"></div>
                <div class="reset-msg">í„°ì¹˜í•˜ì—¬ ì´ˆê¸°í™”</div>
            </div>
        </div>
    </main>

    <script>
        // ================= ë°ì´í„° ì„¤ì • =================
        const participants = {
            1: "ì´í˜œì •", 2: "í™©ë¯¼ì£¼", 3: "ì•ˆì¸ê²½", 4: "ìµœìœ¤ì˜", 5: "ê¹€ê·¼ë§Œ",
            6: "ì´ì„ êµ­", 7: "ìœ¤ì¼ì„", 8: "ì†¡ì£¼í˜„", 9: "ê¹€íƒœì˜¤", 10: "ì´ê·¼í˜¸",
            11: "ì„ì£¼í˜„", 12: "ìµœì •í™˜", 13: "ì„ë•ì›", 14: "ë°•ìœ¤í•œ", 15: "ì‹¬ì¤€ì˜",
            16: "ì´í˜„ì² ", 17: "ê°•ëŒ€í¬", 18: "í˜„ì§„ë‚¨", 19: "ì´ì§„ìš°"
        };

        // ì „ì—­ ë³€ìˆ˜
        let html5QrCode;
        let isScanning = false;
        let currentCameraId = null;

        // 1. ì´ˆê¸°í™” ë° ì¹´ë©”ë¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            html5QrCode = new Html5Qrcode("reader");
            
            // ê¸°ê¸°ì˜ ì¹´ë©”ë¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            Html5Qrcode.getCameras().then(devices => {
                const select = document.getElementById('camera-select');
                select.innerHTML = ""; // ì´ˆê¸°í™”

                if (devices && devices.length) {
                    // ì¹´ë©”ë¼ ëª©ë¡ì„ ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€
                    devices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        // ë¼ë²¨ì´ ì—†ìœ¼ë©´ 'Camera 0', 'Camera 1' ë“±ìœ¼ë¡œ í‘œì‹œ
                        option.text = device.label || `Camera ${index} (${device.id.substr(0,5)}...)`;
                        select.appendChild(option);
                    });

                    // [ì¤‘ìš”] ê°€ì¥ ë§ˆì§€ë§‰ ì¹´ë©”ë¼(ë³´í†µ ê³ ì„±ëŠ¥ í›„ë©´)ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„ íƒ ì‹œë„
                    const lastCamera = devices[devices.length - 1].id;
                    startScanner(lastCamera);
                    select.value = lastCamera;
                } else {
                    select.innerHTML = "<option>No Camera Found</option>";
                    alert("ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }).catch(err => {
                console.error(err);
                alert("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
            });
        });

        // 2. ìŠ¤ìºë„ˆ ì‹œì‘ í•¨ìˆ˜ (í•´ìƒë„ ê°•ì œ ì„¤ì •)
        function startScanner(cameraId) {
            if(isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    startScanner(cameraId); // ì¤‘ë‹¨ í›„ ì¬ì‹œì‘
                });
                return;
            }

            currentCameraId = cameraId;
            
            const config = {
                fps: 10,
                qrbox: { width: 300, height: 300 },
                // [í•µì‹¬] ê³ í™”ì§ˆ(HD) ê°•ì œ ìš”ì²­ -> ì´ˆì  ë¬¸ì œ í•´ê²°
                videoConstraints: {
                    deviceId: { exact: cameraId },
                    width: { min: 1280, ideal: 1920 }, // HD ì´ìƒ
                    height: { min: 720, ideal: 1080 },
                    focusMode: "continuous" // ìë™ ì´ˆì  ìš”ì²­
                }
            };

            html5QrCode.start(
                cameraId, 
                config, 
                onScanSuccess, 
                (errorMessage) => { /* ìŠ¤ìº” ì‹¤íŒ¨ ë¡œê·¸ ë¬´ì‹œ */ }
            ).then(() => {
                isScanning = true;
                // ë¯¸ëŸ¬ë§ ìƒíƒœ í™•ì¸ í›„ ì¬ì ìš©
                updateMirrorStyle();
            }).catch(err => {
                console.error("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨", err);
            });
        }

        // 3. ì¢Œìš° ë°˜ì „ í† ê¸€
        function toggleMirror() {
            const reader = document.getElementById('reader');
            reader.classList.toggle('mirrored');
        }
        
        // ìŠ¤ìºë„ˆ ì¬ì‹œì‘ ì‹œì—ë„ ë¯¸ëŸ¬ë§ ìœ ì§€ìš©
        function updateMirrorStyle() {
            const reader = document.getElementById('reader');
            if(reader.classList.contains('mirrored')) {
                // ë¹„ë””ì˜¤ ìš”ì†Œê°€ ìƒì„±ëœ í›„ ë‹¤ì‹œ í™•ì¸
                const video = document.querySelector('#reader video');
                if(video) video.style.transform = "scaleX(-1)";
            }
        }

        // 4. ìŠ¤ìº” ì„±ê³µ ì‹œ ë¡œì§
        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return;

            const id = parseInt(decodedText);
            if (participants[id]) {
                // ìŠ¤ìº” ì¤‘ì§€
                isScanning = false;
                html5QrCode.stop().then(() => {
                    showResultEffect(id, participants[id]);
                });
            }
        }

        // 5. ê²°ê³¼ ì—°ì¶œ (ë§¤íŠ¸ë¦­ìŠ¤ íš¨ê³¼)
        function showResultEffect(id, name) {
            const overlay = document.getElementById('result-overlay');
            const logArea = document.getElementById('log-area');
            const progBarContainer = document.getElementById('progress-bar-container');
            const progBar = document.getElementById('progress-bar');
            const finalResult = document.getElementById('final-result');
            const winnerName = document.getElementById('winner-name');

            overlay.style.display = 'flex';
            logArea.innerHTML = '';
            progBarContainer.style.display = 'block';
            finalResult.style.display = 'none';

            const logs = [
                `>> TARGET ID DETECTED: [ ${id} ]`,
                `>> CONNECTING TO SECURE SERVER...`,
                `>> VERIFYING HASH KEY... OK`,
                `>> DECRYPTING DATA STREAM...`,
                `>> MATCH FOUND IN DATABASE.`
            ];

            let step = 0;
            const totalSteps = logs.length;
            
            const interval = setInterval(() => {
                if(step < totalSteps) {
                    logArea.innerHTML += logs[step] + "<br>";
                    progBar.style.width = ((step + 1) / totalSteps * 100) + "%";
                    step++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        logArea.style.display = 'none';
                        progBarContainer.style.display = 'none';
                        
                        winnerName.innerText = name;
                        finalResult.style.display = 'block';
                        
                        // í™”ë©´ í„°ì¹˜ ì‹œ ë¦¬ì…‹ ì´ë²¤íŠ¸
                        overlay.onclick = () => window.location.reload();
                    }, 500);
                }
            }, 400);
        }
    </script>
</body>
</html>

